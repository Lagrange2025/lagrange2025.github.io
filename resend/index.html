<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>é‚®ä»¶ç³»ç»Ÿ</title>
</head>
<body>
  <h1>ç®€å•é‚®ä»¶ç³»ç»Ÿ</h1>

  <div id="auth">
    <h2>æ³¨å†Œ</h2>
    <input id="regEmail" placeholder="é‚®ç®±"><br>
    <input id="regPass" type="password" placeholder="å¯†ç "><br>
    <button onclick="register()">æ³¨å†Œ</button>

    <h2>ç™»å½•</h2>
    <input id="logEmail" placeholder="é‚®ç®±"><br>
    <input id="logPass" type="password" placeholder="å¯†ç "><br>
    <button onclick="login()">ç™»å½•</button>
  </div>

  <div id="mail" style="display:none;">
    <h2>å‘é€é‚®ä»¶</h2>
    <input id="to" placeholder="æ”¶ä»¶äºº"><br>
    <input id="subject" placeholder="ä¸»é¢˜"><br>
    <textarea id="body" placeholder="æ­£æ–‡"></textarea><br>
    <button onclick="sendMail()">å‘é€</button>

    <h2>å†å²è®°å½•</h2>
    <button onclick="loadHistory()">åˆ·æ–°å†å²</button>
    <ul id="history"></ul>
  </div>

  <script>
    const API = "http://ä½ çš„å…¬ç½‘IP:3000"; // ğŸ‘ˆæ”¹æˆä½ çš„CVMåœ°å€
    let token = localStorage.getItem("token");

    function register() {
      fetch(API + "/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: document.getElementById("regEmail").value,
          password: document.getElementById("regPass").value
        })
      }).then(r => r.json()).then(d => {
        if (d.token) {
          alert("æ³¨å†ŒæˆåŠŸï¼Œå·²ç™»å½•");
          token = d.token;
          localStorage.setItem("token", token);
          showMail();
        } else alert(d.error || "æ³¨å†Œå¤±è´¥");
      });
    }

    function login() {
      fetch(API + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: document.getElementById("logEmail").value,
          password: document.getElementById("logPass").value
        })
      }).then(r => r.json()).then(d => {
        if (d.token) {
          alert("ç™»å½•æˆåŠŸ");
          token = d.token;
          localStorage.setItem("token", token);
          showMail();
        } else alert(d.error || "ç™»å½•å¤±è´¥");
      });
    }

    function sendMail() {
      fetch(API + "/mail/send", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
          to: document.getElementById("to").value,
          subject: document.getElementById("subject").value,
          html: document.getElementById("body").value
        })
      }).then(r => r.json()).then(d => {
        if (d.ok) alert("é‚®ä»¶å‘é€æˆåŠŸ");
        else alert("å‘é€å¤±è´¥");
      });
    }

    function loadHistory() {
      fetch(API + "/mail/history", {
        headers: { "Authorization": "Bearer " + token }
      }).then(r => r.json()).then(list => {
        const ul = document.getElementById("history");
        ul.innerHTML = "";
        list.forEach(m => {
          const li = document.createElement("li");
          li.textContent = `${m.created_at} â†’ ${m.recipient} [${m.subject}] çŠ¶æ€:${m.status}`;
          ul.appendChild(li);
        });
      });
    }

    function showMail() {
      document.getElementById("auth").style.display = "none";
      document.getElementById("mail").style.display = "block";
      loadHistory();
    }

    if (token) showMail();
  </script>
</body>
</html>